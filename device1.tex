
\chapter{Description of our prototype for spatio-angular illumination}
\label{sec:dev1}
\begin{summary}
  In the preceding chapter I showed the underlying concept of our
  spatio-angular microscope. Here I discuss additional details that
  are important for the practical implementation.

  I explain the beam path, electronic synchronization of the displays
  with other components and an algorithm to transform the coordinate
  system of the camera pixels into the coordinate system of the focal
  plane SLM.
  
  The pupil plane SLM was specifically developed for our project by    
  our partner Fraunhofer IPMS (Dresden, DE). 
  % FIXME more on mma?
\end{summary}
\section{Description of the optical components}
So far I have only shown the beam path for transmissive displays (in
\figref{fig:memi-simple}). Such SLM only have a very low transmission
in practice. Therefore we use reflective displays in our prototype.

In \figref{fig:memi-real} I adjusted the beam path accordingly. This
schematic also depicts the optics we use to adapt light from the laser
to fill the etendue of our system. The light source enters the system
from the bottom left. The optic components are color corrected and
have anti-reflex coating for wavelengths in the range from
\unit[400]{nm} to \unit[700]{nm}.

The system successively illuminates the pupil plane SLM --- a grayscale
micromirror array developed by our project partner Fraunhofer IPMS
Dresden --- and the focal plane SLM, a commercial binary liquid crystal
on silicon display.
 
I gathered some of the following details from the documents that were
created during the development of our prototype and are classified as
confidential. I have summarized the key decisions here and the
relevant project partners have agreed to the publication.


\begin{figure}[!htbp]
  \centering
  \svginput{2}{memi-real}
  \caption{Schematic of the light path through our microscope. Laser
    light enters from the lower left, is scrambled and homogenized to
    illuminate the pupil plane SLM in $\textrm{P}''$ and the focal
    plane SLM in F'. $F$ is the field plane in the sample and its
    primed versions are conjugated planes. $P$ is the pupil of the
    objective. Field mask $B_0$ and Fourier stop $B_1$ are adjustable
    circular apertures. PBS is a polarizing beam splitter. DBS is a
    dichroic beam splitter.  The red boxes deliminate subsystems of
    the illumination system: {\color{Orchid}\bf A$_1$ and A$_2$:}
    light scrambling and homogenization, {\color{Orchid}\bf B:}
    Fourier-optical filter to provide intensity modulating pupil plane
    SLM. {\color{Orchid}\bf C:} Polarization based intensity modulator
    as focal plane SLM. {\color{Orchid}\bf D:} Wide-field fluorescence
    microscope with detection path.}
  \label{fig:memi-real}
\end{figure}

\subsection{Ensuring homogeneous illumination}
A quantitative evaluation of our experiments (FIXME ref sec:results)
with different illumination patterns is simplified when both pupil
plane SLM and focal plane SLM are uniformly illuminated.

We use either a laser\footnote{Lasever LSR473H, diode-pumped solid
  state laser, output power 600mW, $\lambda=\unit[473]{nm}$} or a
light emitting diode (LED) \nomenclature{LED}{light emitting diode} as
the light source in our experiments. Below we discuss optical measures
that attain homogeneity of the illumination of both displays.

The LED\footnote{Huey Jann HPB8-48KBD, wavelength
  $\unit[(463\pm1)]{nm}$, brightness \unit[35]{lm}, view angle
  $120{}^\circ$ %, FIXME TODO: Flaeche messen
} we use has a large active
area. Due to etendue mismatch a relatively large amount of its
produced light will never reach the sample. But it is easy to achieve
a homogeneous illumination. Moreover, the LED can be quickly switched
on and off electronically.

 % \footnote{The DPSS Laser doesn't allow fast
 %  direct electronic switching at full power. We have to use an
 %  acousto-optic modulator connected with the additional expense of its
 %  optical alignment (FIXME siehe spaetere ref section).}.

Unlike an LED, a laser delivers light of considerably higher spectral
radiance ($\unit[]{W/(sr\, m^2 m)}$). Thus it is in principle possible
to use the laser as a highly efficient light source for our
system. Unfortunately, the high spectral and spatial coherence of a
laser often lead to high-contrast fluctuations of the irradiance and
we have to compensate for this by time averaging.

When using the Laser, we send its parallel Gaussian beam into a
bundle\footnote{Fiber bundle with circular cross-section (Loptek,
  Berlin, DE), \unit[1.1]{mm} diameter and \unit[2]{m} length. The
  beam broadening is $3{}^\circ$ and increases, when the bundle is
  bent \citep{Ipp2009}.}  of randomly distributed fibers. This randomizes
the light distribution at the bundle output and also broadens the
illumination angles.

A relay system (A$_1$) images the circular output of the fiber bundle
onto the entrance of a light pipe. This relay system contains a
rotating microlens array\footnote{Array of cross-oriented cylindrical
  lenses on both sides with a pitch of \unit[0.5]{mm} resulting in an
  effective focal length of \unit[6.9]{mm} (LIMO, Dortmund, DE).}. It
is driven by a motor with the axis of rotation being displaced from
the optical axis. This time-varying element allows to reduce speckle.

Both, the fiber bundle and microlens array, increase the etendue of
the laser illumination to the optimum value, which is given by one of
our SLM as discussed below in \ref{sec:etendue-mma}. 

The light  pipe is  a hollow  mirror-integrator tunnel  with quadratic
cross-section and depicted in \figref{fig:integrator-rod}. The mixing
effect of the  tunnel can be understood by  considering the irradiance
in the plane of the tunnel output as it would occur without tunnel.

Drawing the outline of the square cross-section into this irradiance
map selects the light that directly reaches this plane.  Surrounding
this outline with four identical copies that touch its edges selects
the light that will reach the output plane after one reflection. The
irradiance maps from neighbouring squares are mirrored and added to
the direct illumination. Depending on the numerical aperture of the
input light, more reflections may occur --- resulting in the addition
of irradiance from next-nearest-neighbours and so forth.

This improves the uniformity of the light distribution in the output
plane without altering the numerical aperture of the light.  The more
subregions are superimposed, the better will be the uniformity.
Assuming $N$ subregions were overlaid and their contributions were
statistically independent, then according to the central limit theorem
the standard deviation of the irradiance is proportional to
$1/\sqrt{N}$ \citep{Koshel2012}.

However, we also align the source distribution to be rotationally
symmetric about the optical axis and obtain an even more uniform
output than what would follow from this prediction because positive
and negative slopes from different subregions compensate in the
superposition (also \cite{Koshel2012}).

In our system the side length of the cross-section of the tunnel is
\unit[2.5]{mm} and its length of \unit[250]{mm} ensures enough
reflections for homogeneous illumination. A relay system magnifies the
tunnel output to $\unit[4]{mm}\times\unit[4]{mm}$ in the plane
$\textrm{F}'''$.

We thought about using the output of the tunnel directly, without the
additional relais system, but then the length of the tunnel would have
been prohibitively long.

\jpginput{8cm}{integrator-rod}{Hollow mirror-integrator tunnel with a
  quadratic cross section of \unit[2.5]{mm} side length and
  \unit[250]{mm} length.}

Regarding the two relay systems the optical designer at In-Vision
commented \citep{Ipp2009a} that these have not been optimized for
prefect imaging but for the transport of the homogeneous light
distribution. The system A$_1$ at the tunnel entrance has to transfer
the illumination from the round fiber end to the square tunnel
entrance. The engineer designed a good quality system with only two
lenses (and the microlens array). At the other end (A$_2$ in
\figref{fig:memi-real}) five elements carry the light from the tunnel
exit into the field mask $B_0$ in $\textrm{F}'''$.

During the planning phase we also considered a homogenization design
based on a fly's eye condensor (two consecutive microlens
arrays). According to simulations performed by In-Vision, this,
however, would have been more difficult to adjust than the tunnel. In
particular the system would have been more dependent on illumination
wavelength.

In summary the following points are important in order to achieve
homogeneous illumination of focal and pupil plane with the tunnel:
%\renewcommand{\labelitemi}{$\star$}
\begin{itemize}
\item The image of the end of the bundle should properly cover the
  tunnel entrance. Especially the corners of the tunnel should not be
  darker than the center. Inhomogeneous illumination at the tunnel
  entrance leads to inhomogeneous illumination of the pupil plane SLM.
\item The end of the fibre bundle must be adjusted in four axes
  (centering and angle).
\item The focal length of the microlenses should be chosen shorter
  than predicted by pure etendue calculation. In order to compensate
  inevitably occuring microchipping on the edges of the cemented glass
  mirrors.
\end{itemize}

\subsection{Fourier optical filter for contrast generation on pupil
  plane SLM}

The micromirror array, which we use as a pupil plane SLM consists of
torsion mirrors that modulate the phase of the light (see
\figref{fig:mma} for images of the device). In order to modulate the
intensity we use the Fourier optical filter denoted as
'schlierenoptics' in \figref{fig:memi-real}~B.

\jpginput{14cm}{mma}{{\bf left:} Scanning electron microscope image of
  the micro-mirror array (MMA).  The pixel pitch of the device is
  \unit[0.016]{mm}. The hinges for the tilt movement and the
  electrodes are clearly visible. {\bf middle:} Optical reflective
  microscope image of the MMA. {\bf right:} exaggerated rendering of
  how a 8x8 checker board pattern would be displayed on the
  device. Electron and optical micrograph by Fraunhofer IPMS Dresden
  (Germany)}
\begin{figure}[!hbt]
  \centering
  \svginput{.6}{mma-fft}
  \caption{{\bf left:} Measurement of the deflection of micro-mirrors
    using a white-light interferometer (provided by Fraunhofer IPMS
    Dresden (Germany)). {\bf reft:} Simulation of the Fraunhofer
    diffraction pattern of the micro-mirror array for coherent,
    monochromatic light (kindly provided by Joel Seligson). The
    circles with radius $d_\textrm{max}$ indicate the maximum size of
    the field mask B0 where the diffraction orders do not
    overlap. This limits the etendue of our illumination system.}
  \label{fig:mma-fft}
\end{figure}

The lens L1 has two purposes: First, it images the field mask B0 into
the Fourier stop B1. Second, the plane $\textrm{P}''$ with the phase SLM
is imaged to infinity.

With undeflected micromirrors, the SLM has no signifcant effect and
works like a plane mirror. Both planes $\textrm{F}''$ and
$\textrm{P}'$ are then homogeneously illuminated.

If the left half of the micromirrors are tilted, then they direct the
light along the dashed line in \figref{fig:memi-real}. This light is
absorbed by the field stop B1 and therefore missing in $\textrm{P}'$,
i.e.\ the right side in $\textrm{P}'$ is dark. The total radiant flux
($\unit[]{W}$) through the beam stop in $\textrm{F}''$ decreases while
the transmitted irradiance ($\unit[]{W/m^2}$) remains homogeneous.  In
the real system, the lens L1 consists of four glass elements.

The phase distribution $\Phi(\x)$ in MMA plane corresponds to the       \cma{Fourier diffraction pattern}
profile in \figref{fig:mma-fft}~left:
\begin{align}
\label{eq:mma-complex}
 \Phi(\x) =  \sum_\p \left[\underbrace{\left(\exp(i \k(p_x,p_y) \x)\cdot \rect(x,y)\right)}_{\Phi_\p}\otimes
  \delta(x-p_x\Delta x, y-p_y\Delta y)\right]
\end{align}
where $\x=(x,y)$ is a position in the MMA plane, the rectangular
function $\rect$ delimits an individual micro-mirror with its
deflection encoded in $\k=(k_x,k_y)^T$. The index vector
$\p=(p_x,p_y)^T$ indicates the mirror position.

The diffraction pattern of an individual mirror is a $\sinc-$function
which is shifted according to the mirror deflection and a phase
gradient which depends on the mirror position $\p$:
\begin{align}
 \widetilde\Phi_\p(\k)=\mathcal{F}(\Phi_\p(\x)) = \sinc\left(k_x-k(p_x,p_y)\right) \cdot\exp\left(i\k(p_x\Delta x,p_y \Delta y)\right)
\end{align}
Adjacent rows of mirrors tilt in opposite directions ($\pm x$).
Therefore, we can specify the term $\Phi_\p(\x)$ in equation
\ref{eq:mma-complex} more precisely and obtain two expressions:
\begin{align}
  \Phi_\p^{(1)}(x,y)&=e^{+i\k_0\x}\rect(x)\otimes\sum_p\delta(x-p\Delta x) \\
  \Phi_\p^{(2)}(x,y)&=e^{-i\k_0\x}\rect(x)\otimes\sum_p\delta(x-p\Delta x) 
\end{align}
A good analytical description of the surface of the MMA is:
\begin{align}
  \Phi(\x)&=\Phi_\p^{(1)}(x,y) \left(\rect(y)\otimes\sum\textrm{(every second row)}\right) \nonumber \\
  &\qquad+\Phi_\p^{(2)}(x,y) \left(\rect(y)\otimes\sum\textrm{(every second row, shifted by one)}\right)
\end{align}
\figref{fig:mma-fft}~right shows a numerically calculated diffraction
pattern of this structure for a monochromatic plane wave. Suppose the
Fourier stop B1 blocks light outside of the circle with the solid
line. Then the transmitted zero-order irradiance is proportional to
the $\sinc^2$ of the deflection angle.  This applies more or less even
if not all mirrors of the array are deflected. Therefore, we can
modulate the irradiance in the plane $P'$ using this optical system
albeit the transfer function is non-linear.

An accurate prediction of the irradiance in $P'$ is even more    
difficult to describe when the field mask B0 is opened and the
extended source produces illumination that is spatially partially
coherent \citep{Mehta2010a}.

But one thing is clear: The contrast can only achieve good results as    \cma{maximal etendue}
long as higher diffraction (dashed circles in
\figref{fig:mma-fft}~right) orders can not pass the Fourier stop
B1. This limits the size of the field mask B0 to the diameter
$d_\textrm{max}$, assuming that no high frequency pattern is displayed
on the MMA.

The smallest distance between the orders in \figref{fig:mma-fft}~right
corresponds to a structure size $\Lambda$ of two mirror pitches:
$\Lambda=\unit[32]{\mu m}$. Therefore the diffraction angle $\theta$
is:
\begin{align}
  \sin\theta&=\lambda/\Lambda
\end{align}
Utilizing this, we can express the maximum radius:
\begin{align}
  d_\textrm{max} &= f \tan\theta \approx \frac{f\lambda}{\Lambda}
\end{align}
Here, $f$ is the focal length of lens L1. With the F-number $N=f/(2d)$
we can find the maximum etendue of the Fourier optical system:
% f/(2*f l/L) = L/(2*l)
\begin{align}
\mathcal{E} = \frac{\pi A}{4 N^2} = \frac{\pi A\lambda^2}{\Lambda^2},  
\end{align}
with the area $A=(\unit[4]{mm})^2$ of the micro-mirror array.


% (%i1) 16*%pi*.4^2/32^2,numer;
% (%o1)                         .007853981633974483
% (%i2) 16*%pi*.7^2/32^2,numer;
% (%o2)                         .02405281875404685

For our system the maximal etendue is between $\unit[0.0079]{mm^2/sr}$
and $\unit[0.024]{mm^2/sr}$, depending on the wavelength. This is much
smaller than the etendue of a typical microscope objective
($\unit[0.27]{mm^2/sr}$, see section \ref{sec:etendue}) and
corresponds to a field diameter $D_\textrm{field}$ in the specimen
between $\unit[70]{\mu m}$ for a wavelength $\lambda$ of
\unit[400]{nm} and $\unit[125]{\mu m}$ for \unit[700]{nm}, with
\begin{align}
  D_\textrm{field}=\sqrt{\frac{\mathcal{E}}{NA^2 \pi/4}},
\end{align}
where $\textrm{NA}$ is the numerical aperture.

% NA:1.4; eps:0.0079; sqrt(eps/(NA^2*%pi/4)),numer;
% NA:1.4; eps:0.024; sqrt(eps/(NA^2*%pi/4)),numer;


%\jpginput{14cm}{mma-calib}{bal}


\subsection{Relay optics between pupil plane and focal plane SLM}
The lenses L2 and L3 form a double-telecentric relay system with
magnification 2 and image $\textrm{F}''$ onto the focal plane SLM in
$\textrm{F}'$. At the same time these lenses make sure that the pupil
plane SLM is imaged to infinity.
 
The relay system ensures that the pixels of the focal plane SLM are at
the resolution limit, while the pupil plane SLM fills the pupil.

In addition, the relay system enables a simpler mechanical realization
and good contrast. It would already be difficult to accommodate the
focal plane SLM and polarization beam splitter in $\textrm{F}''$ ---
including an adjustable aperture would probably not be feasible at
all.


\subsection{ Contrast generation on focal plane SLM using
  polarization}
The SLM we use to control the focal plane illumination is a           \cma{Why fLCoS and not DMD?}
ferroelectric liquid crystal on silicon device (fLCoS, ForthDD WXGA R3,
UK). Depending on if a pixel is off or om, the returning light either
retains the polarization of the input light or rotates it by 90
degrees \citep{Martinez-Garcia2009}.  From this, a polarization beam
splitter generates a binary intensity contrast (see
\figref{fig:memi-real}~C).

We have not opted for a digital micro-mirror device (DMD), because
those mirrors have sharp edges and loose significant amounts of light
into higher orders that can not contribute to the image in the
specimen. The pixels borders of a fLCoS device are defined by electric
fields and are therefore more blurred. At least in this sense, an
fLCoS based device should be more efficient than a DMD.

We use a wire-grid polarization beam splitter (Moxtek PBF02C,     \cma{polarizing beam splitter}
Orem, UT, US) because they ensure a high enough optical quality, good
contrast and the plate causess less back reflections than a beam
splitter cube.


%- ignacio moreno 2009 operational modes of a ferroelectric lcos
%(FIXME)

The s-polarized component of the incoming light is reflected towards
the SLM. Active pixels of the SLM rotate the polarization of light by
90 degrees and then passes through the beam splitter as p-polarization
in the direction of the microscope. There is a supplementary cleanup
analyzer in the beam path. 

It would also be conceivable to arrange SLM and beam splitter
differently, so that the light coming from the SLM is \emph{reflected}
towards microscope. In this case, however, unwanted bending of the
beam splitter's surface will deteriorate the image quality of the
focal plane SLM. Therefore, we use the beam splitter in transmission.


The beam splitter plate makes the overall optics slightly asymmetric
and thus induces mainly astigmatism and lateral color
\citep{Ipp2009a}. The plate is thin enough (thickness \unit[0.7]{mm}),
so that the design remains diffraction limited.

 	
\jpginput{14cm}{setup-photo-blueprint}{The wide field epi-fluorescence
  microscope with attached illumination head. The positions of the two
  spatial light modulators (pupil plane SLM: micromirror array (MMA)
  and focal plane SLM: liquid crystal on silicon display (LCoS)) are
  indicated. Drawing by Josef Wenisch (In-Vision, Austria).}
	  	
%\jpginput{14cm}{memi-setup-only-lenses}{only lenses7}

\subsection{ Variable telescope as tube lens}
Microscope objectives come with various pupil diameters. The last lens
$\textrm{TL}_\textrm{ill}$ in our illumination system has been
designed as a variable zoom objective (by In-Vision, Guntramsdorf,
Austria), that maps the pupil plane SLM from $\textrm{P}''$ with
variable magnification to $\textrm{P}$.

Unlike conventional zoom telescopes we use three movable lens groups
to guarantee that the image of the pupil plane SLM remains stationary
while the focal plane SLM is always imaged into infinity during
magnification changes.

 % - email mit erhard ipp
 %  - Du gehst jetzt also mit linear polarisiertem Laser direkt in den Lichtmischtunnel?
 %  - Ja. Der Laser wird an zwei Metall-Spiegeln M1 und M2)
 %     reflektiert. Vor dem Mikrolinsenarray messe ich
 %   - (1.885+/-0.005) mW ohne Polarisator, (1.580+/-0.001) mW mit
 %     Polarisator in Maximalstellung und
 %   - (27.26+/-0.01) uW mit Polarisator in Minimumstellung.  Der
 %     Kontrast ist 1.8e-3/27e-6=70:1.


\section{Electronic control of the component}

Both spatial light modulators can run at most with $50\%$ duty         \cma{local pattern storage}
cycle. Therefore it is necessary to synchronize the displays. Their
controllers allow to upload several hundred frames of image data at
the beginning of an experiment and keep them in local storage. Images
can then be selected by fast function calls over USB (focal plane SLM,
fLCoS) or Ethernet (pupil plane SLM, MMA).

The camera (Clara, Andor PLC, Belfast, Northern Ireland) as the        \cma{camera is master}
slowest device is chosen as the master. It provides two TTL
outputs. The output ``fire'' is high while the camera is
integrating. The output ``shutter'' goes high \unit[1]{ms} before
``fire'' and provides enough time (\unit[$>850$]{$\mu$s}) for the MMA
controller to tilt and let the mirrors settle.

The LCoS controller can display its images only for certain discrete    
times (\unit[20]{ms}, \unit[10]{ms}, \unit[5]{ms}, \unit[200]{$\mu$s})
and it is not straight forward to change this via USB
interface. Therefore we always work with a fixed LCoS display time of
\unit[20]{ms}. The ``fire'' output of the camera also switches the
laser on using an acousto-optic modulator (AOM).

When the z-stage is used, the camera is stopped until the stage has
reached its target position.

%\begin{figure}[H]
%  \centering
%  \svginput{memi-electronics}
%  \caption{The camera triggers both spatial light modulators with its
%    TTL outputs. The acousto-optic modulator sends light into the
%    system during camera integration.}
%  \label{fig:memi-electronics}
%\end{figure}






% (FIXME bring both these images into the appendix)

% \begin{figure}[!htbp]
%   \centering
%   \svginput{2}{memi-sketch}
%   \caption{Schematic of the lenses in the MEMI system and their focal
%     lengths. The focal length $f_\textrm{TL}$ of the tube lens can be
%     varied. This allows to scale the second intermediate image
%     $r''_\textrm{MMA}$ of the micro mirror array to fit the back
%     focal plane of different objectives. Dimensions in mm.}
%   \label{fig:memi-sketch}
% \end{figure}





% \begin{figure}[!hbt]
%   \centering
%   \includegraphics[width=7cm]{mma-plain}
%   \includegraphics[width=7cm]{mma-ill}
%   \caption{{\bf left:} Micro mirror array chip during installation of
%     the optics. {\bf right:}~Illuminated micro mirror array in the
%     aligned system.}
%   \label{fig:mma-closeup}
% \end{figure}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "kielhorn_memi"
%%% End: 
